---
title: "figure3"
author: "KCM"
date: "2022-09-01"
output: 
  html_document: default
  word_document: default
  pdf_document: default
code_folding: hide
---
```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

<style>
body {
text-align: justify}
</style>

```{r eval=!exists(".standalone"), message=FALSE, include=!exists(".standalone")}
plotDir = ifelse(exists(".standalone"), "", "part1/")
if(plotDir!="") if(!file.exists(plotDir)) dir.create(plotDir)
knitr::opts_chunk$set(fig.path=plotDir, dev=c("png", "pdf"))
knitr::opts_chunk$set(dpi=600,fig.width=15,fig.height = 10)


library(dplyr)
library(plyr)
library(UpSetR)
library(EnhancedVolcano)
library(PCAtools)
library(reshape2)
library(philentropy)
library(reshape2)
library(ggplot2)
library(readr)
library(ggpmisc)
library(qqplotr)
library(scales)
library(treemap)
library(ggrepel)
library("readxl")
library(ggthemes)
library(pheatmap)
library (plyr)
library(ComplexHeatmap)
library(circlize)
library(Hmisc)         # for correlations and p-values
library(RColorBrewer)  # for color palette
library(gplots)
library(cowplot)
library(ggplotify)


source("..//R_rainclouds.R")
source("..//summarySE.R")
source("..//MLL_PROTEIN/utils.R")


```



# Volcano_Plot_Risk_Cyto_Poor_vs_Good_gene_diff

```{r Volcano_Plot_Risk_Cyto_Poor_vs_Good_gene_diff }

res1 <- read.csv("Risk_Cyto_Poor_vs_Good_gene_diff.txt",sep = "\t",row.names = 1)
#head(res1)

res2 <- res1[,-1]
rownames(res2) <- res1[,1]
#head(res2)
dim(res2)


# p1 <- EnhancedVolcano(res2,lab = NA,x = "log2FoldChange",y = "padj",
#                 #selectLab = c("APOBEC3B","CHD7","AURKB","EYA1","UHRF1","SFMBT1"),
#                 xlim = c(-8.5, 7.5),
#                 xlab = bquote(~Log[1.5]~ "fold change"),
#                 ylab = bquote(~-Log[10]~adjusted~italic(P)),
#                 transcriptPointSize = 1,
#                 transcriptLabSize = 1,
#                 border = "full",
#                 subtitle = "",
#                 pCutoff = 0.0001,
#                 #legendPosition = "bottom",
#                 borderWidth = 1.5,
#                 #legend=c('NS','Log1.5 FC','Adjusted p-value',
#                  #        'Adjusted p-value & Log1.5 FC'),
#                 legendPosition = 'bottom',
#                 legendLabSize = 10,
#                 legendIconSize = 10,
#                 borderColour = "blue",
#                 #drawConnectors = FALSE,
#                 #widthConnectors = 0.01,
#                 colConnectors = 'grey30',
#                 gridlines.major = FALSE,
#                 gridlines.minor = FALSE)


p1 <- EnhancedVolcano(res2,
                lab = NA,
                x = "log2FoldChange",
                y = "pvalue",
                pCutoff = 10e-4,
                FCcutoff = 1.5,
                xlim = c(-8.5, 7.5),
                ylim = c(0, -log10(10e-20)),
                transcriptPointSize = 1.5,
                transcriptLabSize = 2.5,
                shape = c(6, 6, 19, 16),
                title = "",
                subtitle = "Differential expression",
                caption = "FC cutoff, 1.5; adjp-value cutoff, 10e-4",
                legendPosition = "right",
                legendLabSize = 14,
                col = c("grey30", "forestgreen", "royalblue", "red2"),
                colAlpha = 0.9,
                drawConnectors = TRUE,
                hline = NULL,
                widthConnectors = 0.5)





```


# Volcano_Plot_Risk_Intermediate_vs_Good_gene_diff

```{r Risk_Cyto_Intermediate_vs_Good_gene_diff}

res3 <- read.csv("Risk_Cyto_Intermediate_vs_Good_gene_diff.txt",sep = "\t",row.names = 1)
#head(res1)

res4 <- res3[,-1]
rownames(res4) <- res3[,1]
#head(res2)
dim(res4)
#lab = rownames(res2
p2 <- EnhancedVolcano(res4,
                lab = NA,
                x = "log2FoldChange",
                y = "pvalue",
                pCutoff = 10e-4,
                FCcutoff = 1.5,
                xlim = c(-8.5, 7.5),
                ylim = c(0, -log10(10e-20)),
                transcriptPointSize = 1.5,
                transcriptLabSize = 2.5,
                shape = c(6, 6, 19, 16),
                title = "",
                subtitle = "Differential expression",
                caption = "FC cutoff, 1.5; adjp-value cutoff, 10e-4",
                legendPosition = "right",
                legendLabSize = 14,
                col = c("grey30", "forestgreen", "royalblue", "red2"),
                colAlpha = 0.9,
                drawConnectors = TRUE,
                hline = NULL,
                widthConnectors = 0.5)
```




# Intersection of UP DOWN genes from M0 to M5

```{r Upset_plot_Subtype_comparsiosn}

filelist <- list.files('..//figure1/TCGA_data/BEAT_AML/TCGA_AML/Pairwise_comparison/Diff_gene/',pattern = '\\.txt$', full.names = TRUE)
#all_csv <- lapply(filelist,read.table, row.names = 1,sep = "\t",header = TRUE)

res<-lapply(filelist, function(x){
  data.frame(
    set=x,
    Gene=as.character(read.table(x)[,1]),
    val=1)
})

res<-ldply(res)
head(res)

res$set <- gsub("..//figure1/TCGA_data/BEAT_AML/TCGA_AML/Pairwise_comparison/Diff_gene//","",res$set)
res$set <- gsub(".txt","",res$set)


# turn the 3 column long table into a wide
res1<-acast(res,Gene~set,value.var="val",fill=0) 

# force as dataframe
res1<-as.data.frame(res1)

# 1st column must be a name
res1$name=rownames(res1)

# rearrange columns
res2=res1[,c(ncol(res1),1:(ncol(res1)-1))]


 Upset1 <- upset(res2, nsets = 15, main.bar.color = "SteelBlue", sets.bar.color = "DarkCyan", 
      sets.x.label = "Comparison", text.scale = c(rep(1.4, 5), 1), order.by = "freq")


```


# Jensen Shannon Divergence metric for genes with std deviation less than 1

```{r JSD_Low_std}
JSD_MAP = read.csv("../TGCA_subtype_figure3/Low_variantion_JSD.txt",sep = "\t",check.names = FALSE)
df_melt = melt(JSD_MAP, id.vars=c("FAB","Risk_Cyto"))
names(df_melt)[1] = "condition"
names(df_melt)[4] = "RT"


df4 <- summarySE(df_melt, measurevar = "RT", groupvars = c("condition"))
p3 <- ggplot(df_melt,aes(x=condition,y=RT,fill=condition,col=condition))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),
                   alpha = .6,adjust =4)+
  geom_point(aes(x = as.numeric(condition)-.15, y = RT,
                 colour = condition),
             position = position_jitter(width = .05), size = .25, shape = 20)+
  geom_boxplot(aes(x = condition, y = RT, fill = condition),
               outlier.shape = NA, alpha = .5,
               width = .1, colour = "black") +
  geom_point(data = df4, aes(x = as.numeric(condition)+.1,
                             y = RT_mean,
                             group = condition, colour = condition), shape = 18)+
  geom_line(data = df4, aes(x = as.numeric(condition)+.1,
                                                       y = RT_median, group = 1))+
  theme_bw() +
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 

# ggplot(df_melt,aes(x=condition,y=RT,fill=condition,col=condition))+
#   geom_flat_violin(position = position_nudge(x = .2, y = 0),
#                    alpha = .6,adjust =4)+
#   geom_point(aes(x = as.numeric(condition)-.15, y = RT,
#                  colour = condition),
#              position = position_jitter(width = .05), size = .25, shape = 20)+
#   geom_boxplot(aes(x = condition, y = RT, fill = condition),
#                outlier.shape = NA, alpha = .5,
#                width = .1, colour = "black") +
#   geom_point(data = df4, aes(x = as.numeric(condition)+.1,
#                              y = RT_mean,
#                              group = condition, colour = condition), shape = 18) + 
#   geom_errorbar(data = df4, aes(x = as.numeric(condition)+.1, y = RT_mean, group = condition, colour = condition, ymin = RT_mean-se, ymax = RT_mean+se), width = .05) +
#   ylab('RT')+
#   scale_fill_brewer(palette = "Dark2")+scale_colour_brewer(palette = "Dark2")+
#   guides(fill = FALSE, col = FALSE) +
#   geom_blank() + 
#   
#   #facet_grid(.~Risk_Cyto, scales = "free_y", labeller = label_both, switch = "y") +
#   facet_wrap(.~Risk_Cyto, scales = "free", shrink = TRUE) +
#   theme_bw(base_size = 16) +
#   theme(legend.position = "none",
#         strip.background = element_blank(),
#         strip.text = element_text(face = 2, size = 22))+
#   theme_bw() +
#   theme(
#     panel.grid.major = element_blank(), 
#     panel.grid.minor = element_blank(),
#     panel.background = element_rect(fill = "transparent",colour = NA),
#     plot.background = element_rect(fill = "transparent",colour = NA)
#   ) +
#   geom_line(data = df4, aes(x = as.numeric(condition)+.1,
#                             y = RT_mean, group = 1))


```



# Jensen Shannon Divergence  metric for genes with std deviation greater than 1
```{r JSD_High_std}
JSD_MAP = read.csv("../TGCA_subtype_figure3/High_variantion_JSD.txt",sep = "\t",check.names = FALSE)
df_melt = melt(JSD_MAP, id.vars=c("FAB","Risk_Cyto"))
names(df_melt)[1] = "condition"
names(df_melt)[4] = "RT"


df4 <- summarySE(df_melt, measurevar = "RT", groupvars = c("condition"))
p4 <- ggplot(df_melt,aes(x=condition,y=RT,fill=condition,col=condition))+
  geom_flat_violin(position = position_nudge(x = .2, y = 0),
                   alpha = .6,adjust =4)+
  geom_point(aes(x = as.numeric(condition)-.15, y = RT,
                 colour = condition),
             position = position_jitter(width = .05), size = .25, shape = 20)+
  geom_boxplot(aes(x = condition, y = RT, fill = condition),
               outlier.shape = NA, alpha = .5,
               width = .1, colour = "black") +
  geom_point(data = df4, aes(x = as.numeric(condition)+.1,
                             y = RT_mean,
                             group = condition, colour = condition), shape = 18)+
  geom_line(data = df4, aes(x = as.numeric(condition)+.1,
                                                       y = RT_median, group = 1))+
theme_bw() +
  theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 

# ggplot(df_melt,aes(x=condition,y=RT,fill=condition,col=condition))+
#   geom_flat_violin(position = position_nudge(x = .2, y = 0),
#                    alpha = .6,adjust =4)+
#   geom_point(aes(x = as.numeric(condition)-.15, y = RT,
#                  colour = condition),
#              position = position_jitter(width = .05), size = .25, shape = 20)+
#   geom_boxplot(aes(x = condition, y = RT, fill = condition),
#                outlier.shape = NA, alpha = .5,
#                width = .1, colour = "black") +
#   geom_point(data = df4, aes(x = as.numeric(condition)+.1,
#                              y = RT_mean,
#                              group = condition, colour = condition), shape = 18) + 
#   geom_errorbar(data = df4, aes(x = as.numeric(condition)+.1, y = RT_mean, group = condition, colour = condition, ymin = RT_mean-se, ymax = RT_mean+se), width = .05) +
#   ylab('RT')+
#   scale_fill_brewer(palette = "Dark2")+scale_colour_brewer(palette = "Dark2")+
#   guides(fill = FALSE, col = FALSE) +
#   geom_blank() + 
#   
#   #facet_grid(.~Risk_Cyto, scales = "free_y", labeller = label_both, switch = "y") +
#   facet_wrap(.~Risk_Cyto, scales = "free", shrink = TRUE) +
#   theme_bw(base_size = 16) +
#   theme(legend.position = "none",
#         strip.background = element_blank(),
#         strip.text = element_text(face = 2, size = 22))+
#   theme_bw() +
#   theme(
#     panel.grid.major = element_blank(), 
#     panel.grid.minor = element_blank(),
#     panel.background = element_rect(fill = "transparent",colour = NA),
#     plot.background = element_rect(fill = "transparent",colour = NA)
#   ) +
#   geom_line(data = df4, aes(x = as.numeric(condition)+.1,
#                             y = RT_mean, group = 1))



```




# Log2fold change scatter Poor vs Good and Intermediate vs Good common genes 

```{r log2_fc_scatter}

 e1  <- read_delim("..//ID_GENE_LIST/ENSEMBL_ENTREZ_ID.txt", delim = "\t", escape_double = FALSE, 
                   trim_ws = TRUE)
# 
 entrez <- e1 %>% dplyr::select(`Ensembl gene ID`,`Approved symbol`,`NCBI Gene ID`)
 names(entrez)[2] = "Symbol"
 names(entrez)[1] = "gene"
 names(entrez)[3] = "ENTREZID"
 #head(entrez)
 entrez <- entrez[complete.cases(entrez),]


Inter = read.csv("..//TGCA_subtype_figure3/Risk_Cyto_Intermediate_vs_Good_gene_diff.txt",sep = "\t")
Poor = read.csv("..//TGCA_subtype_figure3/Risk_Cyto_Poor_vs_Good_gene_diff.txt",sep = "\t")

Inter = Inter[-c(2)]
Poor = Poor[-c(2)]

Good_Inter =  inner_join(entrez,Inter)
Good_Poor = inner_join(entrez,Poor)


Good_Inter <- Good_Inter %>%
  mutate(UP_DOWN = case_when(
    padj < 0.05 & log2FoldChange > 1 ~ "UP", 
    padj < 0.05 & log2FoldChange < -1 ~ "DOWN",
    TRUE ~ 'NS'))


Good_Poor <- Good_Poor %>%
  mutate(UP_DOWN = case_when(
    padj < 0.05 & log2FoldChange > 1 ~ "UP", 
    padj < 0.05 & log2FoldChange < -1 ~ "DOWN",
    TRUE ~ 'NS'))


Good_Inter_NS_filter = Good_Inter[!grepl("NS", Good_Inter$UP_DOWN),]
Good_Poor_NS_filter = Good_Poor[!grepl("NS", Good_Poor$UP_DOWN),]

Intersect_gene <- as.data.frame(intersect(Good_Inter_NS_filter$gene,Good_Poor_NS_filter$gene))
names(Intersect_gene)[1] = "gene"
Inter_good = inner_join(Intersect_gene,Good_Inter_NS_filter)
Poor_good = inner_join(Intersect_gene,Good_Poor_NS_filter)



Inter_good<-Inter_good[match(Poor_good$gene,Inter_good$gene),]

identical(Inter_good$gene,Poor_good$gene)

Inter_good_fc = Inter_good %>% dplyr::select(Symbol,log2FoldChange)
Poor_good_fc = Poor_good %>% dplyr::select(Symbol,log2FoldChange)

combined_data<-cbind(Inter_good_fc,Poor_good_fc)
dim(combined_data)
head(combined_data)
names(combined_data)[2] = "Inter_good"
names(combined_data)[4] = "Poor_good"

regres_data = combined_data[c(1,2,4)]

regres_data$residuals = abs(lm(Inter_good~Poor_good,data=regres_data)$residuals)
regres_data$group = regres_data$residuals > 2*sd(regres_data$residuals)

regres_data1 <- transform(regres_data, Symbol = as.character(Symbol))


 Scatter <- ggplot(regres_data1, aes(x= Inter_good, y= Poor_good))+
   geom_point(aes(colour = group), size=.8) +
   #geom_text_repel(aes(label=Symbol),hjust=0, vjust=0) + 
   geom_text_repel(aes(label = ifelse(group == TRUE, Symbol, "")))+
   geom_smooth(method=lm, se=FALSE, size=0.1) +
   stat_poly_eq() +
   theme(legend.position="bottom",
         legend.title=element_blank()) 
 

```

# Pathway plot and quantiles for Poor vs good and Intermdieate vs good 

```{r QQ_plot1}
# GI <- read_excel("..//TGCA_subtype_figure3/Good_vs_inter_pathway.xlsx",sheet = 2) 
# t1 <- GI[!duplicated(GI$Term),]
# dim(t1)
# 
# #df <- data.frame(y = rt(26, df = 5), name = letters)
# t2 <- t1 %>% dplyr::select(Term,`Log(q-value)`)
# names(t2)[2] = "qvalue"
# #df <- t2
# 
# GP <- read_excel("..//TGCA_subtype_figure3/Good_poor_pathway.xlsx",sheet = 2) 
# G1 <- GP[!duplicated(GP$Term),]
# 
# G2 <- G1 %>% dplyr::select(Term,`Log(q-value)`)
# names(G2)[2] = "qvalue"
# 
# 
# t2$Comparison = "Intermediate_vs_good"
# G2$Comparison = "Poor_vs_good"

#t2_g2 = rbind(t2,G2)
t2_g2 = read.csv("QQ_plot_data_Inter_poor.txt",sep = "\t")

Risk_quantile <- ggplot(data = t2_g2, mapping = aes(sample = qvalue, color = Comparison, fill = Comparison)) +
  stat_qq_band(alpha=0.5) +
  stat_qq_line() +
  stat_qq_point() +
  theme_bw()+
  facet_wrap(~ Comparison,scales = "free", shrink = TRUE) +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles")


```


# Subtype pathway QQplot UP

```{r Subtype_pathway_qqplot_UP}
q_plot = read.csv("Subtype_pathways/Subtype_pathway_qqplot_UP.txt",sep = ",") 
FAB_UP_quantile <- ggplot(data = q_plot, mapping = aes(sample = q_value_rev, color = Comparison, fill = Comparison)) +
  stat_qq_band(alpha=0.5) +
  stat_qq_line() +
  stat_qq_point() +
  theme_bw()+
  facet_wrap(~ Comparison,scales = "free", shrink = TRUE) +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles")

```

# Subtype pathway QQplot DOWN

```{r Subtype_pathway_qqplot_DOWN}
q_plot1 = read.csv("Subtype_pathways/Subtype_pathway_qqplot_DOWN.txt",sep = ",") 
FAB_down_quantile <- ggplot(data = q_plot1, mapping = aes(sample = q_value_rev, color = Comparison, fill = Comparison)) +
  stat_qq_band(alpha=0.5) +
  stat_qq_line() +
  stat_qq_point() +
  theme_bw()+
  facet_wrap(~ Comparison,scales = "free", shrink = TRUE) +
  labs(x = "Theoretical Quantiles", y = "Sample Quantiles")

```





# Semantic similarity analsyis RISK CYTO

```{r Semantic_similarity}
options(ggrepel.max.overlaps = Inf)
one.data = read.csv("Poor_intermediate_revigo.txt",sep = "\t")

aaa <- one.data
ex <- aaa[aaa$value < -9, ]

 RISK_cyto_similarity <- ggplot(data = ex )+
  geom_point( aes( plot_X, plot_Y, colour = frequency, size = -value), alpha = I(0.6) )+
  scale_colour_gradientn(colours = c("purple", "violet", "yellow", "orange", "red"),
                         limits = c(ceiling(min(aaa$frequency)), ceiling(max(aaa$frequency))))+
  scale_size_continuous(breaks = seq(from = 5, to = round(max(-aaa$value),-1), length.out = 2 ))+
  geom_text_repel(data = ex, aes(plot_X, plot_Y, label = description), colour = I(alpha("black", 0.85)), size = 3 ,
                  min.segment.length = 0, nudge_y = 0.5)+
  xlim(-ceiling(max(abs(min(aaa$plot_X)), abs(max(aaa$plot_X)))), ceiling(max(abs(min(aaa$plot_X)), abs(max(aaa$plot_X))))) +
  ylim(-ceiling(max(abs(min(aaa$plot_Y)), abs(max(aaa$plot_Y)))), ceiling(max(abs(min(aaa$plot_Y)), abs(max(aaa$plot_Y))))) +
  labs(x = "semantic space y", y = "semantic space x", color = "-log10 adj.pvalue", size = "value")



```

# Semantic similarity analsyis Treemap RISK CYTO

```{r Treemap,fig.width=16,fig.height=9}
stuff <- read.csv("Tree_map.txt",sep = "\t")
treemap(
  stuff,
  index = c("representative","description"),
  vSize = "value",
  type = "categorical",
  vColor = "representative",
  title = "Revigo TreeMap",
  inflate.labels = FALSE,      # set this to TRUE for space-filling group labels - good for posters
  lowerbound.cex.labels = 0,   # try to draw as many labels as possible (still, some small squares may not get a label)
  bg.labels = "#CCCCCCAA",   # define background color of group labels
								 # "#CCCCCC00" is fully transparent, "#CCCCCCAA" is semi-transparent grey, NA is opaque
  position.legend = "none"
)

```


# Semantic similarity subtype DOWN
```{r similarity_subtype_DOWN}
options(ggrepel.max.overlaps = Inf)
one.data = read.csv("Subtype_pathways/Revigo_down_semantic.txt",sep = "\t")

aaa <- one.data
ex <- aaa[aaa$dispensability < 0.15, ]

     FAB_DOWN_similarity <- ggplot(data = aaa )+
  geom_point( aes( plot_X, plot_Y, colour = frequency, size = -value), alpha = I(0.6) )+
  scale_colour_gradientn(colours = c("purple", "violet", "yellow", "orange", "red"),
                         limits = c(ceiling(min(aaa$frequency)), ceiling(max(aaa$frequency))))+
  scale_size_continuous(breaks = seq(from = 5, to = round(max(-aaa$value),-1), length.out = 2 ))+
  geom_text_repel(data = ex, aes(plot_X, plot_Y, label = description), colour = I(alpha("black", 0.85)), size = 3 ,
                  min.segment.length = 0, nudge_y = 0.5)+
  xlim(-ceiling(max(abs(min(aaa$plot_X)), abs(max(aaa$plot_X)))), ceiling(max(abs(min(aaa$plot_X)), abs(max(aaa$plot_X))))) +
  ylim(-ceiling(max(abs(min(aaa$plot_Y)), abs(max(aaa$plot_Y)))), ceiling(max(abs(min(aaa$plot_Y)), abs(max(aaa$plot_Y))))) +
  labs(x = "semantic space y", y = "semantic space x", color = "-log10 adj.pvalue", size = "value")


```


# Semantic similarity subtype UP

```{r similarity_subtype_UP}
options(ggrepel.max.overlaps = Inf)
one.data = read.csv("Subtype_pathways/revigo_up_semantic.txt",sep = "\t")

aaa <- one.data
ex <- aaa[aaa$dispensability < 0.15, ]

     FAB_UP_similarity <- ggplot(data = aaa )+
  geom_point( aes( plot_X, plot_Y, colour = frequency, size = -value), alpha = I(0.6) )+
  scale_colour_gradientn(colours = c("purple", "violet", "yellow", "orange", "red"),
                         limits = c(ceiling(min(aaa$frequency)), ceiling(max(aaa$frequency))))+
  scale_size_continuous(breaks = seq(from = 5, to = round(max(-aaa$value),-1), length.out = 2 ))+
  geom_text_repel(data = ex, aes(plot_X, plot_Y, label = description), colour = I(alpha("black", 0.85)), size = 3 ,
                  min.segment.length = 0, nudge_y = 0.5)+
  xlim(-ceiling(max(abs(min(aaa$plot_X)), abs(max(aaa$plot_X)))), ceiling(max(abs(min(aaa$plot_X)), abs(max(aaa$plot_X))))) +
  ylim(-ceiling(max(abs(min(aaa$plot_Y)), abs(max(aaa$plot_Y)))), ceiling(max(abs(min(aaa$plot_Y)), abs(max(aaa$plot_Y))))) +
  labs(x = "semantic space y", y = "semantic space x", color = "-log10 adj.pvalue", size = "value")

```




# Pathway bar plot - Pathway poor

```{r Pathway_Poor,fig.width=15,fig.height=15}
t1 <- read.csv("Pathway_Poor.txt",sep = "\t")
names(t1)[4] = "Pvalue"
names(t1)[1] = "Label"
t4 <- t1[t1$Pvalue < 0.00000000001,]

Poor_pathway<- ggplot(t4, aes(y=reorder(Description, -Pvalue), x=LogQ, fill=Label)) +
geom_col(position=position_dodge2(preserve='single'), color="black") +
labs(x='Description', y='Pvalue') +
scale_x_reverse() +
scale_y_discrete(labels=wrap_format(38))+
  theme(axis.text = element_text(face="bold"),axis.text.y = element_text(size = 10))

```


# Pathway bar plot - Pathway Intermediate

```{r Pathway_Intermediate,fig.width=15,fig.height=15}

P <- read.csv("Pathway_Inter.txt",sep = "\t")
names(P)[4] = "Pvalue"
names(P)[1] = "Label"
P1 <- P[P$Pvalue < 0.00000000001,]

Intermediate_pathway <- ggplot(P1, aes(y=reorder(Description, -Pvalue), x=LogQ, fill=Label)) +
geom_col(position=position_dodge2(preserve='single'), color="black") +
labs(x='Description', y='Pvalue') +
scale_x_reverse() +
scale_y_discrete(labels=wrap_format(38))+
  theme(axis.text = element_text(face="bold"),axis.text.y = element_text(size = 10))

```



# Subtype DOWN pathways jaccard similarity
```{r DOWN_jaccard}

read_excel_allsheets <- function(filename, tibble = FALSE) {
  # I prefer straight data.frames
  # but if you like tidyverse tibbles (the default with read_excel)
  # then just pass tibble = TRUE
  sheets <- readxl::excel_sheets(filename)
  x <- lapply(sheets, function(X) readxl::read_excel(filename, sheet = X))
  if(!tibble) x <- lapply(x, as.data.frame)
  names(x) <- sheets
  x
}

generate_heat_map <- function(mat, title)
{
  
  pheatmap(mat, 
            display_numbers = TRUE,number_format = "%.2f"
          
          )   # set font color of cell labels to black
  
}





DOWN_pathway <- read_excel_allsheets("..//TGCA_subtype_figure3/Subtype_pathways/all_DOWN.xlsx")



#https://stackoverflow.com/questions/61122882/how-to-generate-similarity-scores-heatmap-from-multiple-gene-lists-in-r

my_names = c("Term")
result_abd = lapply(DOWN_pathway, "[",  my_names)
df <- ldply (result_abd, data.frame)
names(df)

names(df)[1] = "Comparison"
library(vegan)
D1 <- vegdist(unclass(table(df$Comparison,df$Term)), method = "jaccard")

#pheatmap(1-as.matrix(D1))
generate_heat_map(as.matrix(1-D1))




```



# Subtype UP pathways jaccard similarity


```{r UP_jaccard}
UP_pathway <- read_excel_allsheets("..//TGCA_subtype_figure3/Subtype_pathways/all_UP.xlsx")


#https://stackoverflow.com/questions/61122882/how-to-generate-similarity-scores-heatmap-from-multiple-gene-lists-in-r

my_names = c("Term")
result_abd = lapply(UP_pathway, "[",  my_names)
df <- ldply (result_abd, data.frame)
names(df)

names(df)[1] = "Comparison"
library(vegan)
D2 <- vegdist(unclass(table(df$Comparison,df$Term)), method = "jaccard")

#pheatmap(1-as.matrix(D2))

generate_heat_map(as.matrix(1-D2))


```


# heatmap less than one std dev

```{r low_std_dev,fig.width=15,fig.height=10}
data1 <- read.csv("..//TGCA_subtype_figure3/Less_than_one_std_deviation.txt",sep = "\t")
meta_dat = read_delim("..//Model_hmap_meta/FAB_table.txt",delim = "\t", escape_double = FALSE, 
                       trim_ws = TRUE)
ann <- data.frame(meta_dat$FAB, meta_dat$Risk_Cyto)

colnames(ann) <- c('FAB', 'Risk_Cyto')
colours <- list('FAB' = c('M0' = 'red2', 'M1' = 'royalblue', 'M2'='gold','M3'='forestgreen','M4'='chocolate','M5'='Purple','M6'='darkgoldenrod1','M7'='deepskyblue','nc'='firebrick2'),
                'Risk_Cyto' = c('Good' = 'limegreen', 'Intermediate' = 'grey' , 'N.D.' ='magenta','Poor'='black'))



colAnn <- HeatmapAnnotation(df = ann,
                            which = 'col',
                            col = colours,
                            annotation_width = unit(c(1, 4), 'cm'),
                            gap = unit(1, 'mm'))

names(data1)[1] = "Symbol"
heat <- t(scale(t(data1[,2:ncol(data1)])))
rownames(heat) <- data1$Symbol
ColAnn <- data.frame(colnames(heat))

myBreaks <- seq(-2, 2, length.out = 100)
myCol <- colorRampPalette(c('royalblue', 'white', 'red3'))(100)

L1_low <- Heatmap(heat,
               #col= colorRamp2(c(-3,-1,0,1,3),c("blue","skyblue","white","lightcoral","red")),
               col = colorRamp2(myBreaks, myCol),
               
                              #heatmap_legend_param=list(at=c(-2.6,-1,0,1,2.6),color_bar="continuous",
                #                         legend_direction="vertical", legend_width=unit(5,"cm"),
                 #                        title_position="topcenter", title_gp=gpar(fontsize=10, fontface="bold")),
               name = "Z-score",
               
               #Row annotation configurations
               cluster_rows=TRUE,
               show_row_dend=FALSE,
               row_title_side="right",
               row_title_gp=gpar(fontsize=8),
               show_row_names=TRUE,
               row_names_side="left",
               
               #Column annotation configuratiions
               cluster_columns=TRUE,
               show_column_dend=T,
               column_title="Clustering",
               column_title_side="top",
               column_title_gp=gpar(fontsize=15, fontface="bold"),
               show_column_names = FALSE,
               column_names_gp = gpar(fontsize = 12, fontface="bold"),
               
               # #Dendrogram configurations: columns
               # clustering_distance_columns="euclidean",
               # clustering_method_columns="complete",
               # column_dend_height=unit(10,"mm"),
               # 
               # #Dendrogram configurations: rows
               # clustering_distance_rows="pearson",
               # clustering_method_rows="complete",
               # row_dend_width=unit(4,"cm"),
               # row_dend_side = "left",
               # row_dend_reorder = TRUE,
               
               clustering_distance_columns = function(x) as.dist(1 - cor(t(x))),
               clustering_method_columns = 'ward.D2',
               clustering_distance_rows = function(x) as.dist(1 - cor(t(x))),
               clustering_method_rows = 'ward.D2',
               # 
               #Splits
              # border=T,
               #row_km = 1,
               #column_km = 1,
               
               #plot params
               #width = unit(5, "inch"),
               #height = unit(4, "inch"),
               #height = unit(0.4, "cm")*nrow(mat),
               
               #Annotations
               top_annotation = colAnn)

```


# heatmap greater than one std dev


```{r High_std_dev,fig.width=15,fig.height=10}
data2 <- read.csv("..//TGCA_subtype_figure3/Greater_than_one_std_deviation.txt",sep = "\t")
meta_dat = read_delim("..//Model_hmap_meta/FAB_table.txt",delim = "\t", escape_double = FALSE, 
                       trim_ws = TRUE)
ann <- data.frame(meta_dat$FAB, meta_dat$Risk_Cyto)

colnames(ann) <- c('FAB', 'Risk_Cyto')
colours <- list('FAB' = c('M0' = 'red2', 'M1' = 'royalblue', 'M2'='gold','M3'='forestgreen','M4'='chocolate','M5'='Purple','M6'='darkgoldenrod1','M7'='deepskyblue','nc'='firebrick2'),
                'Risk_Cyto' = c('Good' = 'limegreen', 'Intermediate' = 'navy' , 'N.D.' ='magenta','Poor'='black'))



colAnn <- HeatmapAnnotation(df = ann,
                            which = 'col',
                            col = colours,
                            annotation_width = unit(c(1, 4), 'cm'),
                            gap = unit(1, 'mm'))

names(data2)[1] = "Symbol"
heat <- t(scale(t(data2[,2:ncol(data2)])))
rownames(heat) <- data2$Symbol
ColAnn <- data.frame(colnames(heat))

myBreaks <- seq(-2, 2, length.out = 100)
myCol <- colorRampPalette(c('royalblue', 'white', 'red3'))(100)

H1_high<- Heatmap(heat,
               #col= colorRamp2(c(-3,-1,0,1,3),c("blue","skyblue","white","lightcoral","red")),
               col = colorRamp2(myBreaks, myCol),
               
                              #heatmap_legend_param=list(at=c(-2.6,-1,0,1,2.6),color_bar="continuous",
                #                         legend_direction="vertical", legend_width=unit(5,"cm"),
                 #                        title_position="topcenter", title_gp=gpar(fontsize=10, fontface="bold")),
               name = "Z-score",
               
               #Row annotation configurations
               cluster_rows=TRUE,
               show_row_dend=FALSE,
               row_title_side="right",
               row_title_gp=gpar(fontsize=8),
               show_row_names=FALSE,
               row_names_side="left",
               
               #Column annotation configuratiions
               cluster_columns=TRUE,
               show_column_dend=T,
               column_title="Clustering",
               column_title_side="top",
               column_title_gp=gpar(fontsize=15, fontface="bold"),
               show_column_names = FALSE,
               column_names_gp = gpar(fontsize = 12, fontface="bold"),
               
               # #Dendrogram configurations: columns
               # clustering_distance_columns="euclidean",
               # clustering_method_columns="complete",
               # column_dend_height=unit(10,"mm"),
               # 
               # #Dendrogram configurations: rows
               # clustering_distance_rows="pearson",
               # clustering_method_rows="complete",
               # row_dend_width=unit(4,"cm"),
               # row_dend_side = "left",
               # row_dend_reorder = TRUE,
               
               clustering_distance_columns = function(x) as.dist(1 - cor(t(x))),
               clustering_method_columns = 'ward.D2',
               clustering_distance_rows = function(x) as.dist(1 - cor(t(x))),
               clustering_method_rows = 'ward.D2',
               # 
               #Splits
              # border=T,
               #row_km = 1,
               #column_km = 1,
               
               #plot params
               #width = unit(5, "inch"),
               #height = unit(4, "inch"),
               #height = unit(0.4, "cm")*nrow(mat),
               
               #Annotations
               top_annotation = colAnn)
```




# Low expression correlation coefficient distribution 

```{r Low_expr_correlation_coef}

flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
  )
}

Low_expr <- read.csv("..//TGCA_subtype_figure3/Less_than_one_std_deviation.txt",sep = "\t",row.names = 1,check.names = FALSE)


res <- rcorr(as.matrix(Low_expr))
cor_matrix <- flattenCorrMatrix(res$r, res$P)

L1<- ggplot(cor_matrix, aes(x=cor)) + geom_histogram(position = "identity", col = colList[2], alpha =0.3, bins =100) +
  geom_vline(xintercept = 0, col = colList[1], linetype = "dashed") + xlim(0.8,1) +
  xlab("Spearman's correlation coefficient") + theme_half +
  ggtitle("") +
  theme(axis.text = element_text(size=18), axis.title = element_text(size=18))

```


# High expression correlation coefficient distribution

```{r High_expr_correlation_coef}

flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
  )
}

High_expr <- read.csv("..//TGCA_subtype_figure3/Greater_than_one_std_deviation.txt",sep = "\t",row.names = 1,check.names = FALSE)

res <- rcorr(as.matrix(High_expr))
cor_matrix <- flattenCorrMatrix(res$r, res$P)

H1<- ggplot(cor_matrix, aes(x=cor)) + geom_histogram(position = "identity", col = colList[2], alpha =0.3, bins =100) +
  geom_vline(xintercept = 0, col = colList[1], linetype = "dashed") + xlim(0.1,1) +
  xlab("Spearman's correlation coefficient") + theme_half +
  ggtitle("") +
  theme(axis.text = element_text(size=18), axis.title = element_text(size=18))

```


# Componnent analysis of Low std deviation genes

```{r Low_std_dev_genes_component_analysis,fig.width=20,fig.height=10}

Low = read.csv("..//TGCA_subtype_figure3/Less_than_one_std_deviation.txt",row.names = 1,sep = "\t",check.names = FALSE)

plot_meta <- read.csv("..//figure1/TCGA_data/BEAT_AML/TCGA_AML/full_cleaned_meta.txt",sep = "\t",row.names = 1)


#colnames(plot_meta)
x <- colnames(plot_meta)
b <- gsub(".", "-", x, fixed = TRUE)
colnames(plot_meta) <- b



df2 <- plot_meta %>%
  dplyr::rename(Age = `Diagnosis-Age`) %>% 
  #mutate(Age = cut(Age, breaks = seq(20, 90, by = 10))) %>% 
  dplyr:: rename(Blast_Percentage =`Bone-Marrow-Blast-Percentage`) %>%
  #mutate(BM_percentage = cut(BM_percentage, breaks = seq(20, 100, by = 10))) %>% 
  dplyr::rename(Cytogenetic_Code = `Cytogenetic-Code--Other-`) %>%
  dplyr::rename(TMB = `TMB--nonsynonymous-`) %>%
  #dplyr::rename(SURVIVAL_STATUS = `Overall-Survival-Status`)%>%
  #dplyr::rename(SURVIVAL_MONTH = `Overall-Survival--Months-`) %>%
  #dplyr::rename(PB_Blast = `PB-Blast-Percentage`) %>%
  dplyr::rename(Risk_Molecular = `Risk--Molecular-`)%>%
  #rename(PB_Blast = `PB-Blast-Percentage`) %>%
  dplyr::rename(Risk_Cyto = `Risk--Cyto-`) %>%
  dplyr::rename(Tumour_subtype = `Tumor-Other-Histologic-Subtype`)
#names(df2) 


df2 <- df2 %>% dplyr::select(FAB,Age,Blast_Percentage,WBC,TMB)





######################## RUN PCA
options(ggrepel.max.overlaps = Inf)


p1 <- pca((Low),metadata = df2,removeVar = FALSE,scale = TRUE)########### run this 

# biplot(p1, x = 'PC5', y = 'PC6',
#        # loadings parameters
#        showLoadings = TRUE,
#        lengthLoadingsArrowsFactor = 1.5,
#        sizeLoadingsNames = 4,
#        colLoadingsNames = 'red4',
#        # other parameters
#        lab = NULL,
#        colby = 'FAB', #colkey = c('ER+'='royalblue', 'ER-'='red3'),
#        hline = 0, vline = c(-25, 0, 25),
#        vlineType = c('dotdash', 'solid', 'dashed'),
#        gridlines.major = FALSE, gridlines.minor = FALSE,
#        pointSize = 5,
#        legendPosition = 'left', legendLabSize = 14, legendIconSize = 8.0,
#       # shape = 'Grade', shapekey = c('Grade 1'=15, 'Grade 2'=17, 'Grade 3'=8),
#        drawConnectors = FALSE,
#        title = 'PCA bi-plot')
#        #subtitle = 'PC1 versus PC2',
#        #caption = '27 PCs ≈ 80%')

#################################################################
p <- p1

pbiplot <- biplot(p,
                  # loadings parameters
                  showLoadings = TRUE,
                  lengthLoadingsArrowsFactor = 1.5,
                  sizeLoadingsNames = 4,
                  colLoadingsNames = 'red4',
                  # other parameters
                  lab = NULL,
                  colby = 'FAB',# colkey = c('ER+'='royalblue', 'ER-'='red3'),
                  hline = 0, vline = c(-25, 0, 25),
                  vlineType = c('dotdash', 'solid', 'dashed'),
                  gridlines.major = FALSE, gridlines.minor = FALSE,
                  pointSize = 5,
                  legendPosition = 'none', legendLabSize = 16, legendIconSize = 8.0,
                  #shape = 'Grade', shapekey = c('Grade 1'=15, 'Grade 2'=17, 'Grade 3'=8),
                  drawConnectors = FALSE,
                  title = 'PCA bi-plot',
                  subtitle = 'PC1 versus PC2',
                  caption = '27 PCs ≈ 80%',
                  returnPlot = FALSE)

ploadings <- plotloadings(p, rangeRetain = 0.01, labSize = 4,
                          title = 'Loadings plot', axisLabSize = 12,
                          subtitle = 'PC1, PC2, PC3, PC4, PC5',
                          caption = 'Top 1% variables',
                          shape = 24, shapeSizeRange = c(4, 8),
                          col = c('limegreen', 'black', 'red3'),
                          legendPosition = 'none',
                          drawConnectors = FALSE,
                          returnPlot = FALSE)

peigencor <- eigencorplot(p,
                          components = getComponents(p, 1:25),
                          metavars = c('FAB','Age','Blast_Percentage','WBC','TMB'),
                          cexCorval = 1.0,
                          fontCorval = 2,
                          posLab = 'all', 
                          rotLabX = 45,
                          scale = TRUE,
                          main = "PC clinical correlates",
                          cexMain = 1.5,
                          plotRsquared = FALSE,
                          corFUN = 'pearson',
                          corUSE = 'pairwise.complete.obs',
                          signifSymbols = c('****', '***', '**', '*', ''),
                          signifCutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1),
                          returnPlot = FALSE)


top_row <- plot_grid(pbiplot,ploadings,
                     ncol = 2,
                     labels = c('A','B'),
                     label_fontfamily = 'serif',
                     label_fontface = 'bold',
                     label_size = 22,
                     align = 'h',
                     rel_widths = c(1.10, 0.80, 1.10))

bottom_row <- plot_grid(as.grob(peigencor),
                        ncol = 1,
                        labels = c('C'),
                        label_fontfamily = 'serif',
                        label_fontface = 'bold',
                        label_size = 22,
                        align = 'h',
                        rel_widths = c(0.8, 1.2))

plot_grid(top_row, bottom_row, ncol = 1,
          rel_heights = c(1.1, 0.9))






```


# Component analysis of high_std dev genes
```{r High_std_dev_genes_component_analysis,fig.width=20,fig.height=10}

High = read.csv("..//TGCA_subtype_figure3/Greater_than_one_std_deviation.txt",row.names = 1,sep = "\t",check.names = FALSE)

####################################################################### Metadata import ############################################
plot_meta <- read.csv("..//figure1/TCGA_data/BEAT_AML/TCGA_AML/full_cleaned_meta.txt",sep = "\t",row.names = 1)


#colnames(plot_meta)
x <- colnames(plot_meta)
b <- gsub(".", "-", x, fixed = TRUE)
colnames(plot_meta) <- b



df2 <- plot_meta %>%
  dplyr::rename(Age = `Diagnosis-Age`) %>% 
  #mutate(Age = cut(Age, breaks = seq(20, 90, by = 10))) %>% 
  dplyr:: rename(Blast_Percentage =`Bone-Marrow-Blast-Percentage`) %>%
  #mutate(BM_percentage = cut(BM_percentage, breaks = seq(20, 100, by = 10))) %>% 
  dplyr::rename(Cytogenetic_Code = `Cytogenetic-Code--Other-`) %>%
  dplyr::rename(TMB = `TMB--nonsynonymous-`) %>%
  #dplyr::rename(SURVIVAL_STATUS = `Overall-Survival-Status`)%>%
  #dplyr::rename(SURVIVAL_MONTH = `Overall-Survival--Months-`) %>%
  #dplyr::rename(PB_Blast = `PB-Blast-Percentage`) %>%
  dplyr::rename(Risk_Molecular = `Risk--Molecular-`)%>%
  #rename(PB_Blast = `PB-Blast-Percentage`) %>%
  dplyr::rename(Risk_Cyto = `Risk--Cyto-`) %>%
  dplyr::rename(Tumour_subtype = `Tumor-Other-Histologic-Subtype`)
#names(df2) 


df2 <- df2 %>% dplyr::select(FAB,Age,Blast_Percentage,WBC,TMB)





######################## RUN PCA
options(ggrepel.max.overlaps = Inf)


p1 <- pca((High),metadata = df2,removeVar = FALSE,scale = TRUE)########### run this 

# biplot(p1, x = 'PC5', y = 'PC6',
#        # loadings parameters
#        showLoadings = TRUE,
#        lengthLoadingsArrowsFactor = 1.5,
#        sizeLoadingsNames = 4,
#        colLoadingsNames = 'red4',
#        # other parameters
#        lab = NULL,
#        colby = 'FAB', #colkey = c('ER+'='royalblue', 'ER-'='red3'),
#        hline = 0, vline = c(-25, 0, 25),
#        vlineType = c('dotdash', 'solid', 'dashed'),
#        gridlines.major = FALSE, gridlines.minor = FALSE,
#        pointSize = 5,
#        legendPosition = 'left', legendLabSize = 14, legendIconSize = 8.0,
#       # shape = 'Grade', shapekey = c('Grade 1'=15, 'Grade 2'=17, 'Grade 3'=8),
#        drawConnectors = FALSE,
#        title = 'PCA bi-plot')
#        #subtitle = 'PC1 versus PC2',
#        #caption = '27 PCs ≈ 80%')

#################################################################
p <- p1

pbiplot <- biplot(p,
                  # loadings parameters
                  showLoadings = TRUE,
                  lengthLoadingsArrowsFactor = 1.5,
                  sizeLoadingsNames = 4,
                  colLoadingsNames = 'red4',
                  # other parameters
                  lab = NULL,
                  colby = 'FAB',# colkey = c('ER+'='royalblue', 'ER-'='red3'),
                  hline = 0, vline = c(-25, 0, 25),
                  vlineType = c('dotdash', 'solid', 'dashed'),
                  gridlines.major = FALSE, gridlines.minor = FALSE,
                  pointSize = 5,
                  legendPosition = 'none', legendLabSize = 16, legendIconSize = 8.0,
                  #shape = 'Grade', shapekey = c('Grade 1'=15, 'Grade 2'=17, 'Grade 3'=8),
                  drawConnectors = FALSE,
                  title = 'PCA bi-plot',
                  subtitle = 'PC1 versus PC2',
                  caption = '27 PCs ≈ 80%',
                  returnPlot = FALSE)

ploadings <- plotloadings(p, rangeRetain = 0.01, labSize = 4,
                          title = 'Loadings plot', axisLabSize = 12,
                          subtitle = 'PC1, PC2, PC3, PC4, PC5',
                          caption = 'Top 1% variables',
                          shape = 24, shapeSizeRange = c(4, 8),
                          col = c('limegreen', 'black', 'red3'),
                          legendPosition = 'none',
                          drawConnectors = FALSE,
                          returnPlot = FALSE)

peigencor <- eigencorplot(p,
                          components = getComponents(p, 1:25),
                          metavars = c('FAB','Age','Blast_Percentage','WBC','TMB'),
                          cexCorval = 1.0,
                          fontCorval = 2,
                          posLab = 'all', 
                          rotLabX = 45,
                          scale = TRUE,
                          main = "PC clinical correlates",
                          cexMain = 1.5,
                          plotRsquared = FALSE,
                          corFUN = 'pearson',
                          corUSE = 'pairwise.complete.obs',
                          signifSymbols = c('****', '***', '**', '*', ''),
                          signifCutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1),
                          returnPlot = FALSE)


top_row <- plot_grid(pbiplot,ploadings,
                     ncol = 2,
                     labels = c('A','B'),
                     label_fontfamily = 'serif',
                     label_fontface = 'bold',
                     label_size = 22,
                     align = 'h',
                     rel_widths = c(1.10, 0.80, 1.10))

bottom_row <- plot_grid(as.grob(peigencor),
                        ncol = 1,
                        labels = c('C'),
                        label_fontfamily = 'serif',
                        label_fontface = 'bold',
                        label_size = 22,
                        align = 'h',
                        rel_widths = c(0.8, 1.2))

plot_grid(top_row, bottom_row, ncol = 1,
          rel_heights = c(1.1, 0.9))


plot_grid(p1, p2,p4, ncol = 2,
          rel_heights = c(1.1, 0.9))

```

#https://support.bioconductor.org/p/103113/
plot_grid(p1,p2,Intermediate_pathway,Poor_pathway,p3,p4,L1,H1,gb,gb1,labels="AUTO", nrow = 3)

#(p1 | p2)/(p3+p4)/(L1+H1)/(gb | gb1)


H1_high 
gb<-grid.grabExpr(draw(H1_high))

gb1<-grid.grabExpr(draw(L1_low))








